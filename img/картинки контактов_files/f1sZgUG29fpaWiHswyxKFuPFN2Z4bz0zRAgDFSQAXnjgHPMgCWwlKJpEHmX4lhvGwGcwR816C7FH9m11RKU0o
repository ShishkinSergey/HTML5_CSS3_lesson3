window.jQuery&&window.bemhtml&&(BEM.DOM.decl({block:"direct-updater",modName:"use-tags",modVal:!0},{setTagsLoader:function(t){this._tagsLoader=t},hasTagsLoader:function(){return Boolean(this._getTagsLoader())},_getLoadingDirectParams:function(t){if(!this._getTagsLoader())return this.__base.apply(this,arguments);var a=$.Deferred(),e=this._getNearestImages(t.pos,t.count);if(!(e instanceof Array))return a.reject().promise();var r=(e=e.filter(this._noDirectData,this)).map(function(t){return this._getTagsData(t).then(function(a){return Object.assign({},t,{tags:a})})},this);return $.when.all(r)},_getTagsData:function(t){var a=$.Deferred();return this._getTagsLoader().get(t.rimId).fail(function(){a.resolve([])}).done(function(t){a.resolve(t)}),a.promise()},_getTagsLoader:function(){return this._tagsDataLoader||(this._tagsDataLoader=BEM.create({block:"tags-data"})),this._tagsDataLoader},_preloadDirect:function(t){if(!this._getTagsLoader())return this.__base.apply(this,arguments);this._getLoadingDirectParams(t).then(function(t){var a=this._prepareLoadingDirectParams(t);this._getDirectLoader().batchLoad(a)}.bind(this))}}),BEM.decl({block:"tags-data",baseBlock:"batch-data-loader"},{getDefaultParams:function(){return{host:"https://yandex.ru/images-apphost/duck",tagsCount:0}},get:function(t){if(!t)return $.Deferred().reject({status:"missing_id"}).promise();var a=this.getLoaded(t),e=this;return a&&a.data?$.Deferred().resolve(a.data).promise():this._getRequest({id:t}).success(this._onSuccess.bind(this,t)).error(this._onError.bind(this,t)).complete(this._onComplete.bind(this,t)).then(function(){return e.getLoaded(t).data})},setConfig:function(t){if(t){var a={count:"tagsCount"};for(var e in t)this.params[a[e]||e]=t[e]}},_getRequest:function(t){var a=BEM.blocks["i-global"],e=a.param("tld")||"ru",r=a.param("query"),s=this.params.duckParams,i=["docid="+t.id,"lang="+e,"count="+this.params.tagsCount,"text="+encodeURIComponent(r)];return this.params.family>=0&&(i.push("family="+this.params.family),i.push("pornowhitelist="+a.param("isPornoWhitelistQuery")),i.push("ipnd="+this._getIpnd())),s&&Array.prototype.push.apply(i,s.split(":")),$.ajax({url:this.params.host,data:i.join("&"),type:"GET",dataType:"json"})},_convert:function(t){return Array.isArray(t)?t:[]},_getIpnd:function(){return $.cookie("ipnd")||"1"}}));